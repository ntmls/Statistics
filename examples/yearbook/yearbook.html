<html>
  <head>
    <script src="../../src/distributions.js"></script>
    <script src="../../src/histogram.js"></script>
    <script src="../../src/list.js"></script>
    <script src="../../src/fun.js"></script>
    <script src="model.js"></script>
    <script src="../../src/smc.js"></script>
    <script>
        
        let errorTraceState = {
            width: 500,
            height: 100,
            iteration: 0,
            index: 0,
            errors: [],
            firstError: 0
        };
        
        // getImageData = string -> ImageData 
        let getImageData = function(image) {
            let canvas = document.createElement("Canvas");
            canvas.width = image.width;
            canvas.height = image.height; 
            let ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0);
            return ctx.getImageData(0, 0, image.width, image.height); 
        }; 

        let getPixel = function(imageData) {
            let scanWidth = imageData.width * 4;
            return function(point) {
                let index = point.y * scanWidth + point.x * 4;
                return new Color(
                    imageData.data[index], 
                    imageData.data[index+1], 
                    imageData.data[index+2], 
                );
            };
        };

        // samples the pixels whithin an image.
        var sampleImage = function(imageData, count) {
            var xs = Distributions.createUniform(0, imageData.width - 1);
            var ys = Distributions.createUniform(0, imageData.height - 1);
            var result = [];
            for(var i = 0; i < count; i++) {
                let x = Math.floor(xs.sample());
                let y = Math.floor(ys.sample());
                let point = new Point(x, y);
                result.push({
                    "point": point,
                    "color": getPixel(imageData)(point)
                });
            }
            return result;
        };
        
        let drawPoints = function(context) {
            return function(points) {
                context.beginPath();
                for(let i = 0; i < points.length; i++) {
                    context.moveTo(points[i].x, points[i].y);
                    context.lineTo(points[i].x + 1, points[i].y + 1);
                }
                context.stroke();
                return points;
            };
        };
        
        let updateErrorState = function(models) {
            errorTraceState.iteration += 1;
            errorTraceState.index += 1;
            if (errorTraceState.index > errorTraceState.width) {
                errorTraceState.index = 0;
            }
            errorTraceState.errors = models.map(function(x) { return x.distance; });
            errorTraceState.maxError = errorTraceState.errors.reduce(function(a,b) {
                    return Math.max(a, b);
                }, 0);
            errorTraceState.minError = errorTraceState.errors.reduce(function(a,b) {
                    return Math.min(a, b);
                }, errorTraceState.errors[0]);
            if (errorTraceState.firstError == 0) {
                errorTraceState.firstError = errorTraceState.maxError;
            }
        };
        
        let drawErrorState = function(errorTraceState) {
            let canvas = document.getElementById("errorTrace");
            let ctx = canvas.getContext('2d');
            ctx.strokeStyle = "black";
            ctx.fillStyle = "white";
            ctx.fillRect(errorTraceState.index,0, 2, errorTraceState.height);
            ctx.beginPath();
            for(let i = 0; i < errorTraceState.errors.length; i++) {
                let v = (errorTraceState.errors[i] / errorTraceState.firstError) * errorTraceState.height;
                ctx.moveTo(errorTraceState.index, v);
                ctx.lineTo(errorTraceState.index + 1, v);
            }
            ctx.stroke();
            let minErrorElem = document.getElementById('minDistance');
            minErrorElem.innerHTML = errorTraceState.minError;
            let maxErrorElem = document.getElementById('maxDistance');
            maxErrorElem.innerHTML = errorTraceState.maxError;
        };
        
        let render = function(data, models) {
            let canvas = document.getElementById("displayCanvas");
            let ctx = canvas.getContext('2d');
            ctx.drawImage(data.image, 0, 0);
            
            //sort models by distance
            sorted = models.sort(function(a, b) {
               return a.distance - b.distance;
            });
            
            // modwls
            ctx.beginPath();
            ctx.strokeStyle = "yellow";
            ctx.lineWidth = "1";
            //for (let i = 0; i < models.length; i++) {
            let top = 1;
            for (let i = 0; i < Math.min(top, models.length); i++) {
                let model = models[i].model;
                for (let j = 0; j < model.length; j++) {
                    let r = model[j];
                    ctx.rect(r.point.x, r.point.y, r.width,r.height);
                }
            };
            ctx.stroke();
            
            // image samples
            let toPoint = function(x) { return x.point; };
            let bgColor = new Color(250, 250, 250);
            let isBg = function(x) { return isBackGroundColor(bgColor)(x.color); };
            let isNotBg = function(x) { return !isBackGroundColor(bgColor)(x.color); };
            let ins = data.imageSamples.filter(isBg);
            ctx.strokeStyle = "blue";
            drawPoints(ctx)(ins.map(toPoint));
            let outs = data.imageSamples.filter(isNotBg);
            ctx.strokeStyle = "red";
            drawPoints(ctx)(outs.map(toPoint));
            
            // error trace
            updateErrorState(models);
            drawErrorState(errorTraceState);
            
        };
        
        let begin = function(image) {
            var count = 200;
            let imageData = getImageData(image);
            let imageSamples = sampleImage(imageData, 5000);
            let data = {
                "image": image,
                "imageSamples": imageSamples
            };
            let priors = getPriors(imageData.width, imageData.height);  
            let samples = initializeSamples(priors, data, count);
            let scheduler = scheduleThresholdsByPercentage(400000, 700, .99);
            
            // render(image, imageSamples, samples);
            setTimeout(function() {
                resample(
                    normalizeWeights(samples), 
                    count, 
                    priors, 
                    data,
                    scheduler, 
                    scheduler.init); 
            }, 0);
        };
        
        let resetErrorTrace = function() {
            errorTraceState.firstError = 0;
        };

    </script>
  </head>
    <body>
        <canvas id="displayCanvas"></canvas><br>
        <canvas id="errorTrace" width="500" height="100"></canvas><br>
        
        <label id="minDistance">Min Distance</label><br>
        <label id="maxDistance">Max Distance</label><br>
        <button onclick="resetErrorTrace()">Reset Error Trace</button>
        <script>
            let canvas = document.getElementById("displayCanvas");
            let ctx = canvas.getContext('2d');
            let img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                begin(img);
            };
            img.src = "pg1.jpg";
        </script>
    </body>
</html>